<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>рдЖрдЧрдВрддреБрдХ рдкрдВрдЬреАрдпрди тАв BJP Office</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #ff6a00, #ffa41b);
      font-family: 'Noto Sans Devanagari', sans-serif;
      display: flex; justify-content: center; padding: 20px 0;
    }
    .container {
      background: #fff8ef; width: 100%; max-width: 600px;
      border-radius: 12px; padding: 30px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    h2 { text-align: center; color: #ff6a00; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 800; color: #5a2d0c; }
    input[type="text"], input[type="tel"], select {
      width: 100%; padding: 10px 14px; border: 2px solid #ffcf99;
      border-radius: 10px; font-size: 16px; background: #fff; outline: none;
    }
    input:focus, select:focus { border-color: #ff8a33; box-shadow: 0 0 0 3px rgba(255,138,51,.2); }
    button, input[type="button"] {
      width: 100%; padding: 12px; background-color: #ff6a00; color: white;
      font-size: 16px; font-weight: 800; border: none; border-radius: 10px;
      cursor: pointer; margin-top: 16px;
    }
    button:hover { background-color: #e55f00; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .row { display:flex; align-items:center; gap:8px; }
    video, canvas { width: 100%; max-height: 300px; margin: 10px 0; border-radius: 10px; background: #000; }
    small.help { color:#7a4a1f }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formHeading">рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ</h2>

    <form id="visitor-form" autocomplete="off">
      <label for="mobile">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░:</label>
      <div class="row">
        <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}" placeholder="10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░" style="flex:1;">
        <span id="mobileSearch" title="рдЦреЛрдЬреЗрдВ" style="cursor:pointer;font-size:20px;margin-top:4px;">ЁЯФН</span>
      </div>

      <label for="name">рдирд╛рдо:</label>
      <input type="text" id="name" name="name" required placeholder="рдЕрдкрдирд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="designation">рдкрдж:</label>
      <input type="text" id="designation" name="designation" required placeholder="рдЖрдкрдХрд╛ рдкрдж рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="address">рдкрддрд╛ / рд╡рд╛рд░реНрдб / рдмреВрде:</label>
      <input type="text" id="address" name="address" required placeholder="рдкреВрд░рд╛ рдкрддрд╛ рд▓рд┐рдЦреЗрдВ">

      <label for="district">рдЬрд┐рд▓рд╛:</label>
      <select id="district" name="district" required onchange="updateMandals()">
        <option value="">рдЬрд┐рд▓рд╛ рдЪреБрдиреЗрдВ</option>
        <option value="Mandsaur">рдордВрджрд╕реМрд░</option>
        <option value="Ratlam">рд░рддрд▓рд╛рдо</option>
        <option value="Nimach">рдиреАрдордЪ</option>
        <option value="Other">рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ</option>
      </select>

      <label for="mandal">рдордВрдбрд▓:</label>
      <select id="mandal" name="mandal" required>
        <option value="">рдкрд╣рд▓реЗ рдЬрд┐рд▓рд╛ рдЪреБрдиреЗрдВ</option>
      </select>

      <label for="reason">рдЖрдиреЗ рдХрд╛ рдХрд╛рд░рдг:</label>
      <select id="reason" name="reason" required>
        <option value="">рдХрд╛рд░рдг рдЪреБрдиреЗрдВ</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдмреИрдардХ</option>
        <option>рдЬрд┐рд▓рд╛ рдЕрдзреНрдпрдХреНрд╖ рд╕реЗ рднреЗрдВрдЯ</option>
        <option>рдЯреНрд░рд╛рдВрд╕рдлрд░ / рд╢рд╛рд╕рдХреАрдп рдХрд╛рд░реНрдп / рд╢рд┐рдХрд╛рдпрдд</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрд╕реНрдерд┐рддрд┐</option>
        <option>рдЕрдиреНрдп рдХреЛрдИ рдХрд╛рд░реНрдп</option>
      </select>

      <label>рд╕реЗрд▓реНрдлреА рд▓реЗрдВ:</label>
      <video id="camera" autoplay playsinline></video>
      <canvas id="snapshot" style="display:none;"></canvas>
      <input type="hidden" id="selfieData" name="selfieData">
      <input type="button" value="ЁЯУ╖ рдлреЛрдЯреЛ рд▓реЗрдВ" id="btnSnap">

      <button type="submit" id="btnSubmit">рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
      <small class="help">рдбреЗрдЯрд╛ рдкрд╣рд▓реЗ рд╕реЗрд╡ рд╣реЛрдЧрд╛, рдлреЛрдЯреЛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рдореЗрдВ рдЕрдкрд▓реЛрдб рд╣реЛрдЧреАред</small>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // 1. UPDATED MANDAL DATA
    const mandalData = {
      "Mandsaur": [
        "рднреЗрдВрд╕реЛрджрд╛", "рднрд╛рдирдкреБрд░рд╛", "рдЧрд░реЛрда", "рдореЗрд▓рдЦреЗрдбрд╛", "рдЦрдбрд╝рд╛рд╡рджрд╛", "рд╢рд╛рдордЧрдврд╝", "рд╕реБрд╡рд╛рд╕рд░рд╛", "рдмрд╕рд╛рдИ",
        "рд╕реАрддрд╛рдордК", "рдХреНрдпрд╛рдордкреБрд░", "рд╕реАрддрд╛рдордК рдЧреНрд░рд╛рдореАрдг", "рдЧреБрд░реНрдЬрд░ рдмрд░рдбрд┐рдпрд╛", "рдзреБрдВрджрдзрдбрд╝рдХрд╛", "рдмреБрдврд╛",
        "рдкрд┐рдкрд▓рд┐рдпрд╛ рдордВрдбреА", "рдорд▓реНрд╣рд╛рд░рдЧрдврд╝", "рджрд▓реЛрджрд╛", "рдордЧрд░рд╛рдорд╛рддрд╛ рдЬреА", "рдордВрджрд╕реМрд░ рдЧреНрд░рд╛рдореАрдг", "рдордВрджрд╕реМрд░ рдЙрддреНрддрд░", "рдордВрджрд╕реМрд░ рджрдХреНрд╖рд┐рдг"
      ],
      "Ratlam": [
        "рд╢реНрдпрд╛рдорд╛ рдкреНрд░рд╕рд╛рдж рдореБрдЦрд░реНрдЬреА", "рдХреБрд╢рд╛рднрд╛рдК рдард╛рдХрд░реЗ", "рд╕реБрд░рдЬрдорд▓ рдЬреИрди", "рдкрдВ. рджреАрдирджрдпрд╛рд▓ рдЙрдкрд╛рдзреНрдпрд╛рдп",
        "рдбреЙ. рднреАрдорд░рд╛рд╡ рдЕрдВрдмреЗрдбрдХрд░", "рдирд╛рдорд▓реА", "рдмрд╛рдВрдЧрд░реЛрдж", "рдерд░рдбрд╝", "рд╢рдмрд░реА", "рдЪрдиреНрджреНрд░рд╢реЗрдЦрд░ рдЖрдЬрд╝рд╛рдж",
        "рд╕реИрд▓рд╛рдирд╛", "рд░рд╛рд╡рдЯреА", "рд╕рд░рд╡рди рдЦреЗрдбрд╝рд╛", "рдмрд╛рдЬрдирд╛", "рд░рд╛рдЬрд╛рдкреБрд░ рдорд╛рддрд╛рдЬреА", "рдЬрд╛рд╡рд░рд╛ рдирдЧрд░",
        "рдорд┐рдВрдбрд▓реЗрд╢реНрд╡рд░ рдорд╣рд╛рджреЗрд╡", "рдбреЙ. рд▓рдХреНрд╖реНрдореАрдирд╛рд░рд╛рдпрдг рдкрд╛рдгреНрдбреЗрдп", "рдкрд┐рдкрд▓реМрджрд╛", "рд╕реБрдЦреЗрдбрд╝рд╛",
        "рдЖрд▓реЛрдЯ", "рддрд╛рд▓", "рдмрдбрд╝рд╛рд╡рджрд╛", "рдЦрд╛рд░рд╡рд╛рдХрд▓рд╛", "рдЬреЛрдЧрдгрд┐рдпрд╛ рдорд╛рддрд╛рдЬреА"
      ],
      "Nimach": [
        "рджреАрдирджрдпрд╛рд▓ рдордВрдбрд▓, рдиреАрдордЪ", "рдореБрдЦрд░реНрдЬреА рдордВрдбрд▓, рдиреАрдордЪ", "рдЙрддреНрддрд░ рдордВрдбрд▓, рдиреАрдордЪ", "рджрдХреНрд╖рд┐рдг рдордВрдбрд▓, рдиреАрдордЪ",
        "рднрд╛рджрд╡рд╛рдорд╛рддрд╛ рдордВрдбрд▓, рдиреАрдордЪ", "рдХреБрд╢рд╛рднрд╛рдК рдордВрдбрд▓, рдиреАрдордЪ", "рджреАрдирджрдпрд╛рд▓ рдордВрдбрд▓, рдордирд╛рд╕рд╛",
        "рдореБрдЦрд░реНрдЬреА рдордВрдбрд▓, рдордирд╛рд╕рд╛", "рдХреБрдХрдбреЗрд╢реНрд╡рд░ рдордВрдбрд▓, рдордирд╛рд╕рд╛", "рд░рд╛рдордкреБрд░рд╛ рдордВрдбрд▓, рдордирд╛рд╕рд╛",
        "рдХреБрд╢рд╛рднрд╛рдК рдордВрдбрд▓, рдордирд╛рд╕рд╛", "рдЬрд╛рд╡рдж рдордВрдбрд▓, рдЬрд╛рд╡рдж", "рдореЛрд░рд╡рди рдордВрдбрд▓, рдЬрд╛рд╡рдж",
        "рд░рддрдирдЧрдврд╝ рдордВрдбрд▓, рдЬрд╛рд╡рдж", "рд╕рд┐рдВрдЧреЛрд▓реА рдордВрдбрд▓, рдЬрд╛рд╡рдж"
      ],
      "Other": ["рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ"]
    };

    // 2. LOGIC: Update Mandal Dropdown
    function updateMandals(selectedMandal = null) {
      const distSelect = document.getElementById("district");
      const mandalSelect = document.getElementById("mandal");
      const district = distSelect.value;
      
      mandalSelect.innerHTML = '<option value="">рдордВрдбрд▓ рдЪреБрдиреЗрдВ</option>';

      if (district && mandalData[district]) {
        mandalData[district].forEach(m => {
          const op = document.createElement("option");
          op.value = m;
          op.textContent = m;
          mandalSelect.appendChild(op);
        });
      }

      if(selectedMandal) {
        // Wait briefly for DOM to update
        setTimeout(() => { mandalSelect.value = selectedMandal; }, 50);
      }
    }

    // 3. FIREBASE SETUP
    const firebaseConfig = {
      apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
      authDomain: "bjplivefirebase.firebaseapp.com",
      projectId: "bjplivefirebase",
      storageBucket: "bjplivefirebase.firebasestorage.app",
      messagingSenderId: "236867156337",
      appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0",
      measurementId: "G-M5KY8DW9JD"
    };
    if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const TELEGRAM_BOT_TOKEN = "8064306737:AAFvXvc3vIT1kyccGiPbpYGCAr9dgKJcRzw";
    const TELEGRAM_CHAT_ID = "733804072";

    const $ = (id) => document.getElementById(id);
    const normMobile = (s) => (s || "").replace(/\D/g, "").slice(-10);

    // 4. CAMERA
    async function compressDataURL(dataURL, maxW=1024, maxH=1024, quality=0.6){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          let {width:w, height:h} = img;
          const ratio = Math.min(maxW/w, maxH/h, 1);
          const cw = Math.round(w*ratio), ch = Math.round(h*ratio);
          const c = document.createElement('canvas'); c.width=cw; c.height=ch;
          c.getContext('2d').drawImage(img,0,0,cw,ch);
          resolve(c.toDataURL('image/jpeg', quality));
        };
        img.src = dataURL;
      });
    }

    const video = $('camera'), canvas = $('snapshot'), selfieInput = $('selfieData');
    async function startCamera(){
      try { 
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); 
        video.srcObject = s; 
      } catch (e) { console.warn('Camera error:', e); }
    }
    startCamera();

    $('btnSnap').addEventListener('click', async () => {
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const raw = canvas.toDataURL('image/jpeg');
      const compact = await compressDataURL(raw);
      selfieInput.value = compact;
      canvas.style.display = 'block';
    });

    // 5. AUTOFILL
    (function bindActiveEvent(){
      const headingEl = $('formHeading');
      const reasonSel = $('reason');
      db.collection('events').where('active','==',true).limit(1).onSnapshot(s=>{
        const d=s.docs[0]?.data(); const evName=(d?.name||'').toString().trim();
        if(evName){ 
            headingEl.textContent=`рдЗрд╡реЗрдВрдЯ: ${evName}`; 
            if(!Array.from(reasonSel.options).some(o=>o.value===evName)){
                const op=document.createElement('option'); op.value=evName; op.textContent=evName;
                reasonSel.insertBefore(op, reasonSel.children[1]);
            }
            reasonSel.value = evName;
        } else { headingEl.textContent='рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ'; }
      });
    })();

    async function autofillFromMobile(mobile){
      if (mobile.length !== 10) return;
      try{
        const [oldSnap, newSnap] = await Promise.all([
          db.collection("jila_format_2025").where("рдореЛрдмрд╛рдЗрд▓", "==", mobile).limit(1).get(),
          db.collection("visitors").where("mobile", "==", mobile).orderBy("timestamp","desc").limit(1).get()
        ]);
        const doc = newSnap.docs[0] || oldSnap.docs[0];
        if (doc) {
          const data = doc.data();
          $('name').value = data["рдирд╛рдо"] || data["name"] || $('name').value;
          $('designation').value = data["рдкрдж"] || data["designation"] || $('designation').value;
          $('address').value = data["рдкрддрд╛"] || data["address"] || $('address').value;
          
          let dist = data["рдЬрд┐рд▓рд╛"] || data["district"] || "Mandsaur";
          let mandal = data["рдордВрдбрд▓"] || data["mandal"];

          // Check if district exists in logic, else default to 'Other'
          if (!mandalData[dist] && dist !== "Other") {
             dist = "Other"; 
          }
          
          $('district').value = dist;
          updateMandals(mandal);
        }
      } catch (err) { console.warn(err); }
    }

    $('mobile').addEventListener('blur', (e)=>{ const m = normMobile(e.target.value); e.target.value = m; autofillFromMobile(m); });
    $('mobileSearch')?.addEventListener('click', ()=>{ $('mobile').dispatchEvent(new Event('blur')); });
    $('mobile').addEventListener('keyup', (e)=>{ if (e.key === 'Enter') $('mobile').dispatchEvent(new Event('blur')); });

    // 6. SUBMIT
    let submitting = false;
    $('visitor-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (submitting) return; submitting = true;
      const btn = $('btnSubmit'); btn.disabled = true; btn.textContent = 'рд╕рдмрдорд┐рдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИтАж';

      const data = {
         name: $('name').value.trim(),
         mobile: normMobile($('mobile').value.trim()),
         designation: $('designation').value.trim(),
         address: $('address').value.trim(),
         district: $('district').value,
         mandal: $('mandal').value,
         reason: $('reason').value,
         selfie: null, selfieUploading: true,
         timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      const selfieData = $('selfieData').value;
      if(!data.name || !data.mobile || !data.district || !data.mandal || !selfieData){
        Swal.fire("Incomplete", "рдХреГрдкрдпрд╛ рд╕рднреА рдлрд╝реАрд▓реНрдб рднрд░реЗрдВред", "warning");
        btn.disabled = false; btn.textContent = 'рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ'; submitting = false; return;
      }

      try{
        const docRef = await db.collection("visitors").add(data);
        (async ()=>{
          try{
            const blob = await (await fetch(selfieData)).blob();
            const path = `selfies/${Date.now()}_${data.mobile}.jpg`;
            const up = await storage.ref(path).put(blob);
            const url = await up.ref.getDownloadURL();
            await docRef.update({ selfie: url, selfieUploading: false });
          }catch(e){ console.warn('Upload fail', e); }
        })();

        try{
          const text = `рдирдпрд╛ рдЖрдЧрдВрддреБрдХ (${data.district}):\nрдирд╛рдо: ${data.name}\nрдореЛрдмрд╛рдЗрд▓: ${data.mobile}\nрдкрдж: ${data.designation}\nрдордВрдбрд▓: ${data.mandal}\nрдХрд╛рд░рдг: ${data.reason}`;
          fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
          }).catch(()=>{});
        }catch(_){}

        Swal.fire("тЬЕ рдзрдиреНрдпрд╡рд╛рдж!", "рдЬрд╛рдирдХрд╛рд░реА рд╕реЗрд╡ рд╣реЛ рдЧрдИ рд╣реИред", "success");
        e.target.reset(); canvas.style.display = "none"; selfieInput.value = ""; 
        updateMandals(); startCamera();

      } catch (err) {
        console.error(err);
        Swal.fire("Error", "рдХреБрдЫ рддреНрд░реБрдЯрд┐ рд╣реБрдИред", "error");
      }
      btn.disabled = false; btn.textContent = 'рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ'; submitting = false;
    });
  </script>
</body>
</html>
