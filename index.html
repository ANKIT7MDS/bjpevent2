<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>рдЖрдЧрдВрддреБрдХ рдкрдВрдЬреАрдпрди</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">

  <!-- ЁЯФБ рдЖрдкрдХреА рдкреБрд░рд╛рдиреА style.css рдХреЛ inline рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ -->
  <style>
  /* Base Reset */
  * { box-sizing: border-box; margin: 0; padding: 0; }

  /* Body & Container Styling */
  body {
    background: linear-gradient(135deg, #ff6a00, #ffa41b);
    font-family: 'Noto Sans Devanagari', sans-serif;
    display: flex; justify-content: center; padding: 20px 0;
  }
  .container {
    background: #fff8ef;
    width: 100%;
    max-width: 600px;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }

  /* Headings & Form Field Labels */
  h2 {
    text-align: center;
    color: #b84000;
    margin-bottom: 16px;
    font-weight: 800;
    letter-spacing: 0.2px;
  }
  label {
    display: block;
    margin: 10px 0 6px;
    color: #5a2d0c;
    font-weight: 700;
    font-size: 15px;
  }

  /* Inputs & Selects */
  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid #ffcf99;
    border-radius: 10px;
    font-size: 16px;
    background: #fff;
    outline: none;
    transition: all .2s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #ff8a33; box-shadow: 0 0 0 3px rgba(255,138,51,.2);
  }
  textarea { resize: vertical; min-height: 70px; }

  /* Buttons */
  button {
    background: #ff6a00; color: white; border: none;
    padding: 12px 16px; border-radius: 10px; cursor: pointer;
    font-weight: 800; width: 100%;
  }
  button:hover { background: #e55f00; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* Camera */
  #camera, #snapshot {
    width: 100%;
    border-radius: 10px;
    margin-top: 8px;
    background: #000;
  }

  /* Status Message */
  #thankYouMsg {
    display: none;
    background: #dff0d8;
    color: #3c763d;
    padding: 16px;
    text-align: center;
    font-weight: bold;
    border-radius: 8px;
    margin-top: 20px;
  }
  </style>
</head>
<body>
  <div class="container">
    <!-- тЬЕ рд╣реЗрдбрд┐рдВрдЧ рдореЗрдВ Active Event рдХрд╛ рдирд╛рдо рдЖрдПрдЧрд╛ -->
    <h2 id="formHeading">рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ</h2>

    <form id="visitor-form">
      <!-- рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ -->
      <label for="mobile">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░:</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}"
               placeholder="10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░" style="flex:1;">
        <span style="font-size:20px;">ЁЯУ▒</span>
      </div>

      <label for="name">рдирд╛рдо:</label>
      <input type="text" id="name" name="name" required placeholder="рдЕрдкрдирд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="designation">рдкрдж:</label>
      <input type="text" id="designation" name="designation" required placeholder="рдЖрдкрдХрд╛ рдкрдж рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="address">рдкрддрд╛ / рд╡рд╛рд░реНрдб / рдмреВрде:</label>
      <textarea id="address" name="address" required placeholder="рдкрддрд╛ рд▓рд┐рдЦреЗрдВ"></textarea>

      <label for="mandal">рдордВрдбрд▓:</label>
      <select id="mandal" name="mandal" required>
        <option value="" selected>-- рдордВрдбрд▓ рдЪреБрдиреЗрдВ --</option>
        <option>рдирдЧрд░</option>
        <option>рдЧреНрд░рд╛рдореАрдг</option>
      </select>

      <label for="reason">рдЖрдиреЗ рдХрд╛ рдХрд╛рд░рдг:</label>
      <select id="reason" name="reason" required>
        <option value="" selected>-- рдХрд╛рд░рдг рдЪреБрдиреЗрдВ --</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдмреИрдардХ</option>
        <option>рдЬрд┐рд▓рд╛ рдЕрдзреНрдпрдХреНрд╖ рд╕реЗ рднреЗрдВрдЯ</option>
        <option>рдЯреНрд░рд╛рдВрд╕рдлрд░ / рд╢рд╛рд╕рдХреАрдп рдХрд╛рд░реНрдп / рд╢рд┐рдХрд╛рдпрдд</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрд╕реНрдерд┐рддрд┐</option>
        <option>рдЕрдиреНрдп рдХреЛрдИ рдХрд╛рд░реНрдп</option>
      </select>
      <div style="color:#834000; font-size:13px; margin:6px 0 10px;">
        * Admin рдореЗрдВ Active Event рд╕реЗрдЯ рд╣реЛрдиреЗ рдкрд░ рдпрд╣ рдЕрдкрдиреЗ-рдЖрдк рдЙрд╕реА рдЗрд╡реЗрдВрдЯ рдХреЗ рдирд╛рдо рдкрд░ рдЪрдпрди рд╣реЛ рдЬрд╛рдПрдЧрд╛ред
      </div>

      <!-- рдХреИрдорд░рд╛ -->
      <label>рд╕реЗрд▓реНрдлрд╝реА:</label>
      <video id="camera" autoplay playsinline></video>
      <canvas id="snapshot" style="display:none;"></canvas>
      <input type="hidden" id="selfieData" />

      <div class="row" style="margin-top:10px;">
        <button type="button" id="btnSnap">рд╕реЗрд▓реНрдлрд╝реА рд▓реЗрдВ</button>
        <button type="submit" id="btnSubmit">рд╕рдмрдорд┐рдЯ</button>
      </div>
    </form>

    <div id="thankYouMsg">рдзрдиреНрдпрд╡рд╛рдж! рдЖрдкрдХреА рдЬрд╛рдирдХрд╛рд░реА рд╕реЗрд╡ рд╣реЛ рдЧрдИ рд╣реИред</div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
  // --- Firebase init (рдЖрдкрдХреЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХрд╛ рд╡рд╣реА config) ---
  const firebaseConfig = {
    apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
    authDomain: "bjplivefirebase.firebaseapp.com",
    projectId: "bjplivefirebase",
    storageBucket: "bjplivefirebase.firebasestorage.app",
    messagingSenderId: "236867156337",
    appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0",
    measurementId: "G-M5KY8DW9JD"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Helpers
  const $ = (id) => document.getElementById(id);
  const normMobile = (s) => (s || '').replace(/\D/g, '').slice(-10);

  // Camera
  const video = $('camera'), canvas = $('snapshot'), selfieInput = $('selfieData');
  async function startCamera() {
    try { const s = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = s; }
    catch (e) { console.warn('Camera error:', e); }
  }
  startCamera();

  $('btnSnap').addEventListener('click', () => {
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    selfieInput.value = canvas.toDataURL('image/jpeg');
    canvas.style.display = 'block';
  });

  // --- Active Event: Header + Reason Prefill ---
  (function bindActiveEvent() {
    const headingEl = $('formHeading');
    const reasonSel = $('reason');

    function ensureOptionAndSelect(value) {
      if (!value) return;
      const exists = Array.from(reasonSel.options).some(o => o.value === value);
      if (!exists) {
        const op = document.createElement('option');
        op.value = value; op.textContent = value;
        // placeholder рдХреЗ рдмрд╛рдж insert
        if (reasonSel.firstChild && reasonSel.firstChild.tagName === "OPTION" && reasonSel.firstChild.value === "") {
          reasonSel.insertBefore(op, reasonSel.firstChild.nextSibling);
        } else { reasonSel.insertBefore(op, reasonSel.firstChild); }
      }
      reasonSel.value = value;
      // reasonSel.disabled = true; // рд▓реЙрдХ рдХрд░рдирд╛ рд╣реЛ рддреЛ рдЕрдирдХреЙрдореЗрдВрдЯ рдХрд░реЗрдВ
    }
    function sanitizeIfNA() {
      const v = (reasonSel.value || '').trim().toLowerCase();
      if (v === 'na' || v === 'n/a') reasonSel.value = '';
    }

    db.collection('events').where('active','==',true).limit(1).onSnapshot(snap => {
      const doc = snap.docs[0];
      const evName = doc && doc.data() && (doc.data().name || '').toString().trim();
      if (evName) {
        headingEl.textContent = `рдЗрд╡реЗрдВрдЯ: ${evName}`;
        sanitizeIfNA();
        ensureOptionAndSelect(evName);
      } else {
        headingEl.textContent = 'рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ';
        // reasonSel.disabled = false;
      }
    });
  })();

  // Mobile normalize
  $('mobile').addEventListener('blur', (e) => {
    e.target.value = normMobile(e.target.value);
  });

  // Submit
  $('visitor-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = $('btnSubmit'); btn.disabled = true;

    const name = $('name').value.trim();
    const mobile = normMobile($('mobile').value.trim());
    const designation = $('designation').value.trim();
    const address = $('address').value.trim();
    const mandal = $('mandal').value;
    const reason = $('reason').value;
    const selfieData = $('selfieData').value;

    if (!name || !mobile || !designation || !address || !mandal || !reason || !selfieData) {
      alert('рдХреГрдкрдпрд╛ рд╕рднреА рдлрд╝реАрд▓реНрдб рднрд░реЗрдВ рдФрд░ рд╕реЗрд▓реНрдлрд╝реА рд▓реЗрдВред'); btn.disabled = false; return;
    }

    try {
      const blob = await (await fetch(selfieData)).blob();
      const path = `selfies/${Date.now()}_${mobile}.jpg`;
      const up = await storage.ref(path).put(blob);
      const selfieURL = await up.ref.getDownloadURL();

      await db.collection('visitors').add({
        name, mobile, designation, address, mandal, reason, selfie: selfieURL,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      $('thankYouMsg').style.display = 'block';
      e.target.reset(); canvas.style.display='none'; selfieInput.value=''; startCamera();
    } catch (err) {
      console.error(err);
      alert('рддреНрд░реБрдЯрд┐ рд╣реБрдИ, рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред');
    }
    btn.disabled = false;
  });
</script>
</body>
</html>
