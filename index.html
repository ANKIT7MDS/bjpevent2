<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>рдЖрдЧрдВрддреБрдХ рдкрдВрдЬреАрдпрди тАв Fast</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://firebasestorage.googleapis.com">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #ff6a00, #ffa41b);
      font-family: 'Noto Sans Devanagari', system-ui, -apple-system, Arial, sans-serif;
      display: flex; justify-content: center; padding: 20px 0;
    }
    .container {
      background: #fff8ef;
      width: 100%; max-width: 600px;
      border-radius: 12px; padding: 30px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    h2 { text-align: center; color: #ff6a00; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 800; color: #5a2d0c; }
    input[type="text"], input[type="tel"], select {
      width: 100%; padding: 10px 14px; border: 2px solid #ffcf99;
      border-radius: 10px; font-size: 16px; background: #fff; outline: none;
    }
    input:focus, select:focus { border-color: #ff8a33; box-shadow: 0 0 0 3px rgba(255,138,51,.2); }
    button, input[type="button"] {
      width: 100%; padding: 12px; background-color: #ff6a00; color: white;
      font-size: 16px; font-weight: 800; border: none; border-radius: 10px;
      cursor: pointer; margin-top: 16px;
    }
    button[disabled]{ opacity: .6; cursor: not-allowed; }
    button:hover, input[type="button"]:hover { background-color: #e55f00; }
    .row { display:flex; align-items:center; gap:8px; }
    video, canvas {
      width: 100%; max-height: 300px; margin: 10px 0;
      display: block; border-radius: 10px; background: #000;
    }
    .swal2-popup { background: rgba(255,255,255,0.95) !important; font-size: 16px; border-radius: 12px !important; box-shadow: 0 4px 14px rgba(0,0,0,0.3); }
    small.help { color:#7a4a1f }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formHeading">рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ</h2>

    <form id="visitor-form" autocomplete="off">
      <label for="mobile">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░:</label>
      <div class="row">
        <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}" placeholder="10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░" style="flex:1;">
        <span id="mobileSearch" title="рдЦреЛрдЬреЗрдВ" style="cursor:pointer;font-size:20px;margin-top:4px;">ЁЯФН</span>
      </div>

      <label for="name">рдирд╛рдо:</label>
      <input type="text" id="name" name="name" required placeholder="рдЕрдкрдирд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="designation">рдкрдж:</label>
      <input type="text" id="designation" name="designation" required placeholder="рдЖрдкрдХрд╛ рдкрдж рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="address">рдкрддрд╛ / рд╡рд╛рд░реНрдб / рдмреВрде:</label>
      <input type="text" id="address" name="address" required placeholder="рдкреВрд░рд╛ рдкрддрд╛ рд▓рд┐рдЦреЗрдВ">

      <label for="mandal">рдордВрдбрд▓:</label>
      <select id="mandal" name="mandal" required>
        <option value="">рдордВрдбрд▓ рдЪреБрдиреЗрдВ</option>
        <option>рднреЗрдВрд╕реЛрджрд╛</option><option>рднрд╛рдирдкреБрд░рд╛</option><option>рдЧрд░реЛрда</option><option>рдореЗрд▓рдЦреЗрдбрд╛</option>
        <option>рдЦреЬрд╛рд╡рджрд╛</option><option>рд╢рд╛рдордЧреЭ</option><option>рд╕реБрд╡рд╛рд╕рд░рд╛</option><option>рдмрд╕рд╛рдИ</option>
        <option>рд╕реАрддрд╛рдордК</option><option>рдХреНрдпрд╛рдордкреБрд░</option><option>рд╕реАрддрд╛рдордК рдЧреНрд░рд╛рдореАрдг</option><option>рдЧреБрд░реНрдЬрд░ рдмрд░рдбрд┐рдпрд╛</option>
        <option>рдзреБрдВрджрдзреЬрдХрд╛</option><option>рдмреБрдврд╛</option><option>рдкрд┐рдкрд▓рд┐рдпрд╛ рдордВрдбреА</option><option>рдорд▓реНрд╣рд╛рд░рдЧреЭ</option>
        <option>рджрд▓реЛрджрд╛</option><option>рдордЧрд░рд╛рдорд╛рддрд╛ рдЬреА</option><option>рдордВрджрд╕реМрд░ рдЧреНрд░рд╛рдореАрдг</option><option>рдордВрджрд╕реМрд░ рдЙрддреНрддрд░</option>
        <option>рдордВрджрд╕реМрд░ рджрдХреНрд╖рд┐рдг</option><option>рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ рдЖрдпреЗ</option>
      </select>

      <label for="reason">рдЖрдиреЗ рдХрд╛ рдХрд╛рд░рдг:</label>
      <select id="reason" name="reason" required>
        <option value="">рдХрд╛рд░рдг рдЪреБрдиреЗрдВ</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдмреИрдардХ</option>
        <option>рдЬрд┐рд▓рд╛ рдЕрдзреНрдпрдХреНрд╖ рд╕реЗ рднреЗрдВрдЯ</option>
        <option>рдЯреНрд░рд╛рдВрд╕рдлрд░ / рд╢рд╛рд╕рдХреАрдп рдХрд╛рд░реНрдп / рд╢рд┐рдХрд╛рдпрдд</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрд╕реНрдерд┐рддрд┐</option>
        <option>рдЕрдиреНрдп рдХреЛрдИ рдХрд╛рд░реНрдп</option>
      </select>

      <label>рд╕реЗрд▓реНрдлреА рд▓реЗрдВ:</label>
      <video id="camera" autoplay playsinline></video>
      <canvas id="snapshot" style="display:none;"></canvas>
      <input type="hidden" id="selfieData" name="selfieData">
      <input type="button" value="ЁЯУ╖ рдлреЛрдЯреЛ рд▓реЗрдВ" id="btnSnap">

      <button type="submit" id="btnSubmit">рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
      <small class="help">рдЗрд╡реЗрдВрдЯ рдХреЗ рд╕рдордп рддреЗрдЬрд╝ рд╕рдмрдорд┐рдЯ рдХреЗ рд▓рд┐рдП: рдлреЙрд░реНрдо рдкрд╣рд▓реЗ рд╕реЗрд╡ рд╣реЛрдЧрд╛, рдлрд╝реЛрдЯреЛ рдереЛрдбрд╝реА рджреЗрд░ рдмрд╛рдж рдЕрдкрдиреЗ-рдЖрдк рдЬреБрдбрд╝ рдЬрд╛рдПрдЧреАред</small>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
      authDomain: "bjplivefirebase.firebaseapp.com",
      projectId: "bjplivefirebase",
      storageBucket: "bjplivefirebase.firebasestorage.app",
      messagingSenderId: "236867156337",
      appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0",
      measurementId: "G-M5KY8DW9JD"
    };
    if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    try { db.enablePersistence && db.enablePersistence({ synchronizeTabs: true }); }
    catch (e) { console.warn('Persistence not enabled:', e.message||e); }

    const TELEGRAM_BOT_TOKEN = "8064306737:AAFvXvc3vIT1kyccGiPbpYGCAr9dgKJcRzw";
    const TELEGRAM_CHAT_ID = "733804072";

    const $ = (id) => document.getElementById(id);
    const normMobile = (s) => (s || "").replace(/\D/g, "").slice(-10);

    async function compressDataURL(dataURL, maxW=1024, maxH=1024, quality=0.6){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          let {width:w, height:h} = img;
          const ratio = Math.min(maxW/w, maxH/h, 1);
          const cw = Math.round(w*ratio), ch = Math.round(h*ratio);
          const c = document.createElement('canvas');
          c.width=cw; c.height=ch;
          const ctx=c.getContext('2d');
          ctx.drawImage(img,0,0,cw,ch);
          resolve(c.toDataURL('image/jpeg', quality));
        };
        img.src = dataURL;
      });
    }

    const video = $('camera'), canvas = $('snapshot'), selfieInput = $('selfieData');
    async function startCamera(){
      try { const s = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = s; }
      catch (e) { console.warn('Camera error:', e); }
    }
    startCamera();

    $('btnSnap').addEventListener('click', async () => {
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const raw = canvas.toDataURL('image/jpeg');
      const compact = await compressDataURL(raw, 1024, 1024, 0.6);
      selfieInput.value = compact;
      canvas.style.display = 'block';
    });

    (function bindActiveEvent(){
      const headingEl = $('formHeading');
      const reasonSel = $('reason');

      function ensureOptionAndSelect(value){
        if(!value) return;
        const exists = Array.from(reasonSel.options).some(o=>o.value===value);
        if(!exists){
          const op=document.createElement('option'); op.value=value; op.textContent=value;
          if (reasonSel.firstChild && reasonSel.firstChild.tagName==="OPTION" && reasonSel.firstChild.value===""){
            reasonSel.insertBefore(op, reasonSel.firstChild.nextSibling);
          } else { reasonSel.insertBefore(op, reasonSel.firstChild); }
        }
        reasonSel.value = value;
      }
      function sanitizeIfNA(){
        const v=(reasonSel.value||'').trim().toLowerCase();
        if(v==='na'||v==='n/a') reasonSel.value='';
      }

      db.collection('events').where('active','==',true).limit(1).onSnapshot(s=>{
        const d=s.docs[0]?.data(); const evName=(d?.name||'').toString().trim();
        if(evName){ headingEl.textContent=`рдЗрд╡реЗрдВрдЯ: ${evName}`; sanitizeIfNA(); ensureOptionAndSelect(evName); }
        else { headingEl.textContent='рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ'; }
      });
    })();

    async function autofillFromMobile(mobile){
      if (mobile.length !== 10) return;
      try{
        const [oldSnap, newSnap] = await Promise.all([
          db.collection("jila_format_2025").where("рдореЛрдмрд╛рдЗрд▓", "==", mobile).limit(1).get(),
          db.collection("visitors").where("mobile", "==", mobile).orderBy("timestamp","desc").limit(1).get()
        ]);
        const doc = newSnap.docs[0] || oldSnap.docs[0];
        if (doc) {
          const data = doc.data();
          $('name').value = data["рдирд╛рдо"] || data["name"] || $('name').value;
          $('designation').value = data["рдкрдж"] || data["designation"] || $('designation').value;
          $('address').value = data["ржкрддрд╛"] || data["address"] || $('address').value;
          const mandalVal = data["рдордВрдбрд▓"] || data["mandal"];
          if (mandalVal) {
            if (!Array.from($('mandal').options).some(o=>o.value===mandalVal)) {
              const op = document.createElement('option'); op.value = mandalVal; op.textContent = mandalVal;
              $('mandal').appendChild(op);
            }
            $('mandal').value = mandalVal;
          }
        }
      } catch (err) { console.warn('Auto-fill error:', err); }
    }

    $('mobile').addEventListener('blur', (e)=>{ const m = normMobile(e.target.value); e.target.value = m; autofillFromMobile(m); });
    $('mobileSearch')?.addEventListener('click', ()=>{ const input = $('mobile'); input.dispatchEvent(new Event('blur', { bubbles: true })); });
    $('mobile').addEventListener('keyup', (e)=>{ if (e.key === 'Enter') e.currentTarget.dispatchEvent(new Event('blur', { bubbles: true })); });

    let submitting = false;
    $('visitor-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (submitting) return; submitting = true;

      const btn = $('btnSubmit'); btn.disabled = true; btn.textContent = 'рд╕рдмрдорд┐рдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИтАж';

      const name = $('name').value.trim();
      const mobile = normMobile($('mobile').value.trim());
      const designation = $('designation').value.trim();
      const address = $('address').value.trim();
      const mandal = $('mandal').value;
      const reason = $('reason').value;
      const selfieData = $('selfieData').value;

      if(!name || !mobile || !designation || !address || !mandal || !reason || !selfieData){
        Swal.fire("Incomplete", "рдХреГрдкрдпрд╛ рд╕рднреА рдлрд╝реАрд▓реНрдб рднрд░реЗрдВ рдФрд░ рд╕реЗрд▓реНрдлрд╝реА рд▓реЗрдВред", "warning");
        btn.disabled = false; btn.textContent = 'рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ'; submitting = false; return;
      }

      try{
        const docRef = await db.collection("visitors").add({
          name, mobile, designation, address, mandal, reason,
          selfie: null, selfieUploading: true,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        (async ()=>{
          try{
            const blob = await (await fetch(selfieData)).blob();
            const path = `selfies/${Date.now()}_${mobile}.jpg`;
            const up = await storage.ref(path).put(blob);
            const selfieURL = await up.ref.getDownloadURL();
            await docRef.update({ selfie: selfieURL, selfieUploading: false });
          }catch(err){ console.warn('Selfie upload failed', err); }
        })();

        try{
          const text = `рдирдпрд╛ рдЖрдЧрдВрддреБрдХ:\nрдирд╛рдо: ${name}\nрдореЛрдмрд╛рдЗрд▓: ${mobile}\nрдкрдж: ${designation}\nрдордВрдбрд▓: ${mandal}\nрдкрддрд╛: ${address}\nрдХрд╛рд░рдг: ${reason}`;
          fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
          }).catch(()=>{});
        }catch(_){}

        Swal.fire("тЬЕ рдзрдиреНрдпрд╡рд╛рдж!", "рдЖрдкрдХреА рдЬрд╛рдирдХрд╛рд░реА рд╕реЗрд╡ рд╣реЛ рдЧрдИ рд╣реИред рдлреЛрдЯреЛ рдереЛрдбрд╝реА рджреЗрд░ рдореЗрдВ рдЬреБрдбрд╝ рдЬрд╛рдПрдЧреАред", "success");
        e.target.reset(); canvas.style.display = "none"; selfieInput.value = ""; startCamera();

      } catch (err) {
        console.error(err);
        Swal.fire("Error", "рдХреБрдЫ рддреНрд░реБрдЯрд┐ рд╣реБрдИ, рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред", "error");
      }

      btn.disabled = false; btn.textContent = 'рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ'; submitting = false;
    });
  </script>
</body>
</html>
