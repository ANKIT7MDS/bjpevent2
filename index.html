<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡§Ü‡§ó‡§Ç‡§§‡•Å‡§ï ‡§™‡§Ç‡§ú‡•Ä‡§Ø‡§®</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">

  <!-- üîÅ ‡§Ü‡§™‡§ï‡•Ä ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä style.css ‡§ï‡•ã inline ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à -->
  <style>
  /* Base Reset */
  * { box-sizing: border-box; margin: 0; padding: 0; }

  /* Body & Container Styling */
  body {
    background: linear-gradient(135deg, #ff6a00, #ffa41b);
    font-family: 'Noto Sans Devanagari', sans-serif;
    display: flex; justify-content: center; padding: 20px 0;
  }
  .container {
    background: #fff8ef;
    width: 100%;
    max-width: 600px;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }

  /* Headings & Form Field Labels */
  h2 {
    text-align: center;
    color: #b84000;
    margin-bottom: 16px;
    font-weight: 800;
    letter-spacing: 0.2px;
  }
  label {
    display: block;
    margin: 10px 0 6px;
    color: #5a2d0c;
    font-weight: 700;
    font-size: 15px;
  }

  /* Inputs & Selects */
  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid #ffcf99;
    border-radius: 10px;
    font-size: 16px;
    background: #fff;
    outline: none;
    transition: all .2s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #ff8a33; box-shadow: 0 0 0 3px rgba(255,138,51,.2);
  }
  textarea { resize: vertical; min-height: 70px; }

  /* Buttons */
  button {
    background: #ff6a00; color: white; border: none;
    padding: 12px 16px; border-radius: 10px; cursor: pointer;
    font-weight: 800; width: 100%;
  }
  button:hover { background: #e55f00; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* Camera */
  #camera, #snapshot {
    width: 100%;
    border-radius: 10px;
    margin-top: 8px;
    background: #000;
  }

  /* Status Message */
  #thankYouMsg {
    display: none;
    background: #dff0d8;
    color: #3c763d;
    padding: 16px;
    text-align: center;
    font-weight: bold;
    border-radius: 8px;
    margin-top: 20px;
  }
  </style>
</head>
<body>
  <div class="container">
    <!-- ‚úÖ ‡§π‡•á‡§°‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç Active Event ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ü‡§è‡§ó‡§æ -->
    <h2 id="formHeading">‡§≠‡§æ‡§ú‡§™‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à</h2>

    <form id="visitor-form">
      <!-- ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ -->
      <label for="mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞:</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}"
               placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞" style="flex:1;">
        <span style="font-size:20px;">üì±</span>
      </div>

      <label for="name">‡§®‡§æ‡§Æ:</label>
      <input type="text" id="name" name="name" required placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">

      <label for="designation">‡§™‡§¶:</label>
      <input type="text" id="designation" name="designation" required placeholder="‡§Ü‡§™‡§ï‡§æ ‡§™‡§¶ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">

      <label for="address">‡§™‡§§‡§æ / ‡§µ‡§æ‡§∞‡•ç‡§° / ‡§¨‡•Ç‡§•:</label>
      <textarea id="address" name="address" required placeholder="‡§™‡§§‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç"></textarea>

      <label for="mandal">‡§Æ‡§Ç‡§°‡§≤:</label>
      <select id="mandal" name="mandal" required>
        <option value="" selected>-- ‡§Æ‡§Ç‡§°‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
        <option>‡§®‡§ó‡§∞</option>
        <option>‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£</option>
      </select>

      <label for="reason">‡§Ü‡§®‡•á ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£:</label>
      <select id="reason" name="reason" required>
        <option value="" selected>-- ‡§ï‡§æ‡§∞‡§£ ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
        <option>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§¨‡•à‡§†‡§ï</option>
        <option>‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑ ‡§∏‡•á ‡§≠‡•á‡§Ç‡§ü</option>
        <option>‡§ü‡•ç‡§∞‡§æ‡§Ç‡§∏‡§´‡§∞ / ‡§∂‡§æ‡§∏‡§ï‡•Ä‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§Ø / ‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§</option>
        <option>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</option>
        <option>‡§Ö‡§®‡•ç‡§Ø ‡§ï‡•ã‡§à ‡§ï‡§æ‡§∞‡•ç‡§Ø</option>
      </select>
      <div style="color:#834000; font-size:13px; margin:6px 0 10px;">
        * Admin ‡§Æ‡•á‡§Ç Active Event ‡§∏‡•á‡§ü ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ø‡§π ‡§Ö‡§™‡§®‡•á-‡§Ü‡§™ ‡§â‡§∏‡•Ä ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ï‡•á ‡§®‡§æ‡§Æ ‡§™‡§∞ ‡§ö‡§Ø‡§® ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
      </div>

      <!-- ‡§ï‡•à‡§Æ‡§∞‡§æ -->
      <label>‡§∏‡•á‡§≤‡•ç‡§´‡§º‡•Ä:</label>
      <video id="camera" autoplay playsinline></video>
      <canvas id="snapshot" style="display:none;"></canvas>
      <input type="hidden" id="selfieData" />

      <div class="row" style="margin-top:10px;">
        <button type="button" id="btnSnap">‡§∏‡•á‡§≤‡•ç‡§´‡§º‡•Ä ‡§≤‡•á‡§Ç</button>
        <button type="submit" id="btnSubmit">‡§∏‡§¨‡§Æ‡§ø‡§ü</button>
      </div>
    </form>

    <div id="thankYouMsg">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§Ü‡§™‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§</div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
  // --- Firebase init (‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§æ ‡§µ‡§π‡•Ä config) ---
  const firebaseConfig = {
    apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
    authDomain: "bjplivefirebase.firebaseapp.com",
    projectId: "bjplivefirebase",
    storageBucket: "bjplivefirebase.firebasestorage.app",
    messagingSenderId: "236867156337",
    appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0",
    measurementId: "G-M5KY8DW9JD"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Helpers
  const $ = (id) => document.getElementById(id);
  const normMobile = (s) => (s || '').replace(/\D/g, '').slice(-10);

  // Camera
  const video = $('camera'), canvas = $('snapshot'), selfieInput = $('selfieData');
  async function startCamera() {
    try { const s = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = s; }
    catch (e) { console.warn('Camera error:', e); }
  }
  startCamera();

  $('btnSnap').addEventListener('click', () => {
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    selfieInput.value = canvas.toDataURL('image/jpeg');
    canvas.style.display = 'block';
  });

  // --- Active Event: Header + Reason Prefill ---
  (function bindActiveEvent() {
    const headingEl = $('formHeading');
    const reasonSel = $('reason');

    function ensureOptionAndSelect(value) {
      if (!value) return;
      const exists = Array.from(reasonSel.options).some(o => o.value === value);
      if (!exists) {
        const op = document.createElement('option');
        op.value = value; op.textContent = value;
        // placeholder ‡§ï‡•á ‡§¨‡§æ‡§¶ insert
        if (reasonSel.firstChild && reasonSel.firstChild.tagName === "OPTION" && reasonSel.firstChild.value === "") {
          reasonSel.insertBefore(op, reasonSel.firstChild.nextSibling);
        } else { reasonSel.insertBefore(op, reasonSel.firstChild); }
      }
      reasonSel.value = value;
      // reasonSel.disabled = true; // ‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã ‡§§‡•ã ‡§Ö‡§®‡§ï‡•â‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç
    }
    function sanitizeIfNA() {
      const v = (reasonSel.value || '').trim().toLowerCase();
      if (v === 'na' || v === 'n/a') reasonSel.value = '';
    }

    db.collection('events').where('active','==',true).limit(1).onSnapshot(snap => {
      const doc = snap.docs[0];
      const evName = doc && doc.data() && (doc.data().name || '').toString().trim();
      if (evName) {
        headingEl.textContent = `‡§á‡§µ‡•á‡§Ç‡§ü: ${evName}`;
        sanitizeIfNA();
        ensureOptionAndSelect(evName);
      } else {
        headingEl.textContent = '‡§≠‡§æ‡§ú‡§™‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à';
        // reasonSel.disabled = false;
      }
    });
  })();

  // Mobile normalize
  $('mobile').addEventListener('blur', (e) => {
    e.target.value = normMobile(e.target.value);
  });

  // Submit
  $('visitor-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = $('btnSubmit'); btn.disabled = true;

    const name = $('name').value.trim();
    const mobile = normMobile($('mobile').value.trim());
    const designation = $('designation').value.trim();
    const address = $('address').value.trim();
    const mandal = $('mandal').value;
    const reason = $('reason').value;
    const selfieData = $('selfieData').value;

    if (!name || !mobile || !designation || !address || !mandal || !reason || !selfieData) {
      alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•á‡§≤‡•ç‡§´‡§º‡•Ä ‡§≤‡•á‡§Ç‡•§'); btn.disabled = false; return;
    }

    try {
      const blob = await (await fetch(selfieData)).blob();
      const path = `selfies/${Date.now()}_${mobile}.jpg`;
      const up = await storage.ref(path).put(blob);
      const selfieURL = await up.ref.getDownloadURL();

      await db.collection('visitors').add({
        name, mobile, designation, address, mandal, reason, selfie: selfieURL,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      $('thankYouMsg').style.display = 'block';
      e.target.reset(); canvas.style.display='none'; selfieInput.value=''; startCamera();
    } catch (err) {
      console.error(err);
      alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à, ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
    }
    btn.disabled = false;
  });
</script>
</body>
</html>
