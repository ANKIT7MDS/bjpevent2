<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard ‚Ä¢ BJP Office</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f4f6f8; font-family: 'Noto Sans Devanagari', sans-serif; }
    
    .header {
      background: linear-gradient(135deg, #ff6a00, #d35400);
      color: white; padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: sticky; top: 0; z-index: 100;
    }
    
    .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    
    /* Search & Filter Bar */
    .controls {
      display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .search-input {
      flex: 2; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 16px; outline: none; min-width: 200px;
    }
    .filter-select {
      flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 16px; outline: none; background: white; min-width: 150px; cursor: pointer;
    }

    .data-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .card {
      background: white; border-radius: 10px; overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-left: 5px solid #ff6a00;
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    
    .card-header {
      padding: 10px 15px; background: #fff5eb;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #eee; font-size: 14px;
    }
    .card-body { padding: 15px; display: flex; gap: 15px; }
    
    .user-img {
      width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
      border: 2px solid #ffcf99; background: #eee; cursor: pointer;
    }
    .info { flex: 1; }
    .info h3 { font-size: 18px; color: #333; margin-bottom: 5px; }
    .info p { font-size: 14px; color: #666; margin-bottom: 3px; }
    
    .badges { margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap; }
    .tag { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .tag-dist { background: #e3f2fd; color: #1565c0; } /* Blue for District */
    .tag-mandal { background: #fff3e0; color: #e65100; } /* Orange for Mandal */
    .tag-reason { background: #fce4ec; color: #c2185b; } /* Pink for Reason */

    .actions { padding: 10px 15px; border-top: 1px solid #eee; text-align: right; }
    .btn-del {
      background: #ffebee; color: #c62828; border: none; padding: 5px 10px;
      border-radius: 5px; cursor: pointer; font-size: 13px;
    }
    .loader { text-align: center; padding: 50px; color: #777; }
    .stats {
      position: fixed; bottom: 20px; right: 20px;
      background: #333; color: white; padding: 10px 20px;
      border-radius: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: bold;
    }
  </style>
</head>
<body>

<div class="header">
  <h2>üö© ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï ‡§™‡•à‡§®‡§≤ (Admin)</h2>
  <button onclick="exportData()" style="background:white; color:#ff6a00; border:none; padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
    <i class="fas fa-file-excel"></i> Export Excel
  </button>
</div>

<div class="container">
  <div class="controls">
    <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡§®‡§æ‡§Æ, ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." onkeyup="filterCards()">
    
    <select id="districtFilter" class="filter-select" onchange="filterCards()">
      <option value="">All Districts (‡§∏‡§≠‡•Ä ‡§ú‡§ø‡§≤‡•á)</option>
      <option value="Mandsaur">Mandsaur (‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞)</option>
      <option value="Ratlam">Ratlam (‡§∞‡§§‡§≤‡§æ‡§Æ)</option>
      <option value="Nimach">Nimach (‡§®‡•Ä‡§Æ‡§ö)</option>
      <option value="Other">Other (‡§Ö‡§®‡•ç‡§Ø)</option>
    </select>
  </div>

  <div id="loader" class="loader">Loading data...</div>
  <div id="grid" class="data-grid"></div>
</div>

<div class="stats" id="totalCount">Total: 0</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // 1. PASSWORD GUARD
  const pass = prompt("Enter Admin Password:");
  if(pass !== "bjp123") { 
    document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;color:red;'>Access Denied ‚ùå</h2>";
    throw new Error("Wrong Password");
  }

  // 2. FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
    authDomain: "bjplivefirebase.firebaseapp.com",
    projectId: "bjplivefirebase",
    storageBucket: "bjplivefirebase.firebasestorage.app",
    messagingSenderId: "236867156337",
    appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0",
    measurementId: "G-M5KY8DW9JD"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const grid = document.getElementById('grid');
  const loader = document.getElementById('loader');
  let allData = [];

  // 3. FETCH DATA
  db.collection("visitors").orderBy("timestamp", "desc").limit(200)
    .onSnapshot((snapshot) => {
      loader.style.display = 'none';
      allData = [];
      grid.innerHTML = ""; 

      snapshot.forEach(doc => {
        let d = doc.data();
        d.id = doc.id;
        // Ensure district field exists for filtering
        d.district = d.district || (d.District) || "Unknown"; 
        allData.push(d);
        renderCard(d);
      });
      document.getElementById('totalCount').innerText = `Total: ${snapshot.size}`;
      filterCards(); // Re-apply filters if data updates
    }, (error) => { console.error(error); loader.innerHTML = "Error loading."; });

  // 4. RENDER CARD
  function renderCard(d) {
    const time = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleString('hi-IN') : 'Just now';
    const imgUrl = d.selfie || 'https://via.placeholder.com/150?text=No+Img';
    
    // Create card with data-district attribute for easy filtering
    const card = document.createElement('div');
    card.className = 'card searchable';
    card.setAttribute('data-district', d.district); 

    card.innerHTML = `
      <div class="card-header">
        <span style="color:#777;">üïí ${time}</span>
      </div>
      <div class="card-body">
        <img src="${imgUrl}" class="user-img" onclick="viewImage('${imgUrl}', '${d.name}')">
        <div class="info">
          <h3>${d.name}</h3>
          <p>üìû <a href="tel:${d.mobile}" style="text-decoration:none;color:#555;">${d.mobile}</a></p>
          <p>üë®‚Äçüíº ${d.designation}</p>
          <p>üìç ${d.address}</p>
          
          <div class="badges">
            <span class="tag tag-dist">${d.district}</span>
            <span class="tag tag-mandal">${d.mandal}</span>
            <span class="tag tag-reason">${d.reason}</span>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-del" onclick="deleteEntry('${d.id}')"><i class="fas fa-trash"></i> Delete</button>
      </div>
    `;
    grid.appendChild(card);
  }

  // 5. FILTER LOGIC (Text + District)
  window.filterCards = () => {
    const textSearch = document.getElementById('searchInput').value.toLowerCase();
    const distFilter = document.getElementById('districtFilter').value;
    const cards = document.getElementsByClassName('searchable');
    
    let visibleCount = 0;

    Array.from(cards).forEach(card => {
      const cardText = card.innerText.toLowerCase();
      const cardDist = card.getAttribute('data-district');

      // Logic: Both conditions must be true
      const matchText = cardText.includes(textSearch);
      // If filter is empty (""), show all. Else match exact district.
      // Also handle "Other" logic if needed, but usually exact match works best.
      const matchDist = (distFilter === "") || (cardDist === distFilter);

      if(matchText && matchDist) {
        card.style.display = "block";
        visibleCount++;
      } else {
        card.style.display = "none";
      }
    });
    
    document.getElementById('totalCount').innerText = `Total: ${visibleCount}`;
  }

  window.viewImage = (url, name) => {
    Swal.fire({ title: name, imageUrl: url, imageWidth: 400, confirmButtonText: 'Close' });
  }

  window.deleteEntry = async (id) => {
    const res = await Swal.fire({
      title: 'Delete?', text: "Permanent delete!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'
    });
    if (res.isConfirmed) {
      db.collection("visitors").doc(id).delete();
    }
  }

  window.exportData = () => {
    let csv = "Name,Mobile,Designation,Address,District,Mandal,Reason,Time\n";
    allData.forEach(r => {
      const t = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString() : '';
      csv += `"${r.name}","${r.mobile}","${r.designation}","${r.address}","${r.district}","${r.mandal}","${r.reason}","${t}"\n`;
    });
    const link = document.createElement("a");
    link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
    link.download = "visitors_data.csv";
    document.body.appendChild(link);
    link.click();
  }
</script>
</body>
</html>
