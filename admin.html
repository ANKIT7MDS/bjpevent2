<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Super Admin ‚Ä¢ BJP Office</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f0f2f5; font-family: 'Noto Sans Devanagari', sans-serif; padding-bottom: 50px; }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #ff6a00, #d35400);
      color: white; padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: sticky; top: 0; z-index: 100;
    }
    .header h2 { font-size: 1.4rem; margin: 0; }
    .header-btns { display: flex; gap: 10px; }
    .btn {
      border: none; padding: 8px 14px; border-radius: 6px; font-weight: bold; cursor: pointer;
      display: flex; align-items: center; gap: 5px; font-size: 14px;
    }
    .btn-white { background: white; color: #d35400; }
    .btn-event { background: #333; color: #fff; }

    .container { padding: 20px; max-width: 1400px; margin: 0 auto; }

    /* CHARTS SECTION */
    .stats-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px; margin-bottom: 25px;
    }
    .stat-card {
      background: white; padding: 15px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex; flex-direction: column; align-items: center;
    }
    .stat-card h3 { font-size: 16px; color: #555; margin-bottom: 10px; width: 100%; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    canvas { max-height: 200px; width: 100%; }

    /* TABLES SECTION */
    .analytics-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px; margin-bottom: 25px;
    }
    .table-box {
      background: white; border-radius: 10px; padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .table-box h3 { color: #ff6a00; margin-bottom: 10px; border-bottom: 2px solid #ffefe0; padding-bottom: 8px; }
    
    .mini-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .mini-table th { text-align: left; background: #f8f9fa; padding: 8px; color: #666; font-size: 12px; }
    .mini-table td { padding: 8px; border-bottom: 1px solid #eee; color: #333; }
    .mini-table tr:last-child td { border-bottom: none; }
    .badge-count { background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 12px; }

    /* FILTERS */
    .filters-box {
      background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
    }
    .search-input {
      flex: 2; padding: 10px; border: 1px solid #ccc; border-radius: 6px; min-width: 200px;
    }
    .filter-select {
      flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; min-width: 140px; background: #fff;
    }
    .date-input {
      padding: 10px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor:pointer;
    }
    .count-badge {
      background: #333; color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; white-space: nowrap;
    }

    /* DATA GRID */
    .data-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 15px;
    }
    .card {
      background: white; border-radius: 10px; overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-left: 5px solid #ff6a00;
      transition: all 0.2s; position: relative;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    
    .card-header {
      padding: 10px 15px; background: #fff5eb; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; font-size: 13px; color: #666;
    }
    .card-body { padding: 15px; display: flex; gap: 15px; }
    .user-img {
      width: 70px; height: 70px; border-radius: 50%; object-fit: cover;
      border: 2px solid #ffcf99; background: #eee; cursor: pointer;
    }
    .info h3 { margin: 0 0 5px; font-size: 18px; color: #333; }
    .info p { margin: 2px 0; font-size: 14px; color: #555; }
    
    .tags { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px; }
    .tag { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
    .tag-dist { background: #e3f2fd; color: #1565c0; }
    .tag-mandal { background: #fff3e0; color: #e65100; }
    .tag-reason { background: #f3e5f5; color: #7b1fa2; }

    .actions {
      padding: 10px; border-top: 1px solid #eee; text-align: right;
    }
    .btn-del {
      background: #ffebee; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;
    }
    
    #loader { text-align: center; margin-top: 50px; font-size: 18px; color: #666; }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header">
  <h2>üö© ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï (Admin)</h2>
  <div class="header-btns">
    <button class="btn btn-event" onclick="manageEvent()">
      <i class="fas fa-calendar-check"></i> ‡§á‡§µ‡•á‡§Ç‡§ü: <span id="currentEventName">Loading...</span>
    </button>
    <button class="btn btn-white" onclick="exportData()">
      <i class="fas fa-file-excel"></i> Excel
    </button>
  </div>
</div>

<div class="container">
  
  <div class="stats-row">
    <div class="stat-card">
      <h3>üìä ‡§ú‡§ø‡§≤‡•á‡§µ‡§æ‡§∞ ‡§Ü‡§ó‡§Ç‡§§‡•Å‡§ï (District Stats)</h3>
      <canvas id="districtChart"></canvas>
    </div>
    <div class="stat-card">
      <h3>üéØ ‡§ï‡§æ‡§∞‡§£ / ‡§á‡§µ‡•á‡§Ç‡§ü (Event Stats)</h3>
      <canvas id="reasonChart"></canvas>
    </div>
  </div>

  <div class="analytics-row">
    <div class="table-box">
      <h3>üèÜ ‡§ü‡•â‡§™ ‡§Æ‡§Ç‡§°‡§≤ (Top 5 Mandals)</h3>
      <table class="mini-table">
        <thead><tr><th>‡§Æ‡§Ç‡§°‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</th></tr></thead>
        <tbody id="topMandalBody"></tbody>
      </table>
    </div>

    <div class="table-box">
      <h3>üìã ‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç (Recent)</h3>
      <div style="margin-bottom:10px; font-size:14px;">
        <b>‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§á‡§µ‡•á‡§Ç‡§ü:</b> <span id="activeEventDisplay" style="color:#2ecc71; font-weight:bold;">Checking...</span>
      </div>
      <table class="mini-table">
        <thead><tr><th>‡§®‡§æ‡§Æ</th><th>‡§∏‡§Æ‡§Ø</th><th>‡§ú‡§ø‡§≤‡§æ</th></tr></thead>
        <tbody id="recentVisitorsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="filters-box">
    <div style="display:flex; gap:5px; align-items:center;">
      <label style="font-size:12px; font-weight:bold;">From:</label>
      <input type="date" id="dateFrom" class="date-input" onchange="applyFilters()">
    </div>
    <div style="display:flex; gap:5px; align-items:center;">
      <label style="font-size:12px; font-weight:bold;">To:</label>
      <input type="date" id="dateTo" class="date-input" onchange="applyFilters()">
    </div>

    <input type="text" id="search" class="search-input" placeholder="üîç ‡§®‡§æ‡§Æ, ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." onkeyup="applyFilters()">
    
    <select id="filterDist" class="filter-select" onchange="applyFilters()">
      <option value="">‡§∏‡§≠‡•Ä ‡§ú‡§ø‡§≤‡•á</option>
    </select>

    <select id="filterMandal" class="filter-select" onchange="applyFilters()">
      <option value="">‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤</option>
    </select>

    <select id="filterReason" class="filter-select" onchange="applyFilters()">
      <option value="">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡§£ / ‡§á‡§µ‡•á‡§Ç‡§ü</option>
    </select>
    
    <span class="count-badge" id="totalCount">Total: 0</span>
    <button class="btn btn-white" style="border:1px solid #ccc;" onclick="clearFilters()">Reset</button>
  </div>

  <div id="loader">Loading 5000+ Records...</div>
  <div id="grid" class="data-grid"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  const pass = prompt("Enter Admin Password:");
  if(pass !== "bjp123") { document.body.innerHTML = "<h2 style='text-align:center;color:red;margin-top:50px;'>Access Denied</h2>"; throw "Access Denied"; }

  const firebaseConfig = {
    apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
    authDomain: "bjplivefirebase.firebaseapp.com",
    projectId: "bjplivefirebase",
    storageBucket: "bjplivefirebase.firebasestorage.app",
    messagingSenderId: "236867156337",
    appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0",
    measurementId: "G-M5KY8DW9JD"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let allData = [];
  let distChartInst = null;
  let reasonChartInst = null;

  // --- 1. EVENT NAME CHECK ---
  db.collection('events').where('active','==',true).onSnapshot(snap => {
    if(!snap.empty){
      const evName = snap.docs[0].data().name;
      document.getElementById('currentEventName').innerText = evName;
      document.getElementById('activeEventDisplay').innerText = evName;
    } else {
      document.getElementById('currentEventName').innerText = "None";
      document.getElementById('activeEventDisplay').innerText = "Koi Event Active Nahi Hai";
      document.getElementById('activeEventDisplay').style.color = "#777";
    }
  });

  // --- 2. LOAD ALL DATA (Limit Increased) ---
  // Limit increased to 5000 to show old history
  db.collection("visitors").orderBy("timestamp", "desc").limit(5000)
    .onSnapshot(snap => {
      document.getElementById('loader').style.display = 'none';
      allData = [];
      snap.forEach(doc => {
        let d = doc.data();
        d.id = doc.id;
        
        // Data Cleaning
        if(!d.district && !d.District) d.district = "Mandsaur";
        else { let rd = d.district || d.District; d.district = rd.charAt(0).toUpperCase() + rd.slice(1); }
        d.mandal = d.mandal || d.Mandal || "Unknown";
        d.reason = d.reason || d.Reason || "Other";
        
        // Date parsing for filter
        if(d.timestamp) d.jsDate = new Date(d.timestamp.seconds * 1000);
        
        allData.push(d);
      });
      
      populateDropdowns(); 
      updateAnalyticsTables(allData); 
      applyFilters();      
    });

  function updateAnalyticsTables(data) {
    // Top Mandals
    const mandalCounts = {};
    data.forEach(d => { if(d.mandal!=="Unknown") mandalCounts[d.mandal] = (mandalCounts[d.mandal]||0)+1; });
    const sorted = Object.entries(mandalCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const mBody = document.getElementById('topMandalBody');
    mBody.innerHTML = "";
    sorted.forEach(([n,c])=> mBody.innerHTML+=`<tr><td>${n}</td><td><span class="badge-count">${c}</span></td></tr>`);

    // Recent
    const rBody = document.getElementById('recentVisitorsBody');
    rBody.innerHTML = "";
    data.slice(0,5).forEach(d => {
      const t = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
      rBody.innerHTML += `<tr><td>${d.name}</td><td style="font-size:12px;color:#777;">${t}</td><td>${d.district}</td></tr>`;
    });
  }

  // --- 3. FILTER LOGIC (With Date) ---
  function applyFilters() {
    const txt = document.getElementById('search').value.toLowerCase();
    const fDist = document.getElementById('filterDist').value;
    const fMandal = document.getElementById('filterMandal').value;
    const fReason = document.getElementById('filterReason').value;
    
    const dFrom = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
    const dTo = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;
    if(dTo) dTo.setHours(23,59,59); // Include full end day

    const filtered = allData.filter(d => {
      // Text Match
      const matchTxt = (d.name+d.mobile+d.mandal).toLowerCase().includes(txt);
      
      // Dropdown Match
      const matchDist = fDist === "" || d.district === fDist;
      const matchMandal = fMandal === "" || d.mandal === fMandal;
      const matchReason = fReason === "" || d.reason === fReason;

      // Date Match
      let matchDate = true;
      if(d.jsDate) {
        if(dFrom && d.jsDate < dFrom) matchDate = false;
        if(dTo && d.jsDate > dTo) matchDate = false;
      }

      return matchTxt && matchDist && matchMandal && matchReason && matchDate;
    });

    renderGrid(filtered);
    updateCharts(filtered);
    document.getElementById('totalCount').innerText = `Total: ${filtered.length}`;
  }

  function clearFilters(){
    document.getElementById('search').value = "";
    document.getElementById('filterDist').value = "";
    document.getElementById('filterMandal').value = "";
    document.getElementById('filterReason').value = "";
    document.getElementById('dateFrom').value = "";
    document.getElementById('dateTo').value = "";
    applyFilters();
  }

  function renderGrid(data) {
    const grid = document.getElementById('grid');
    grid.innerHTML = "";
    // Show max 200 cards in DOM to prevent lag, but counts remain accurate
    const displayData = data.slice(0, 200); 
    
    displayData.forEach(d => {
      const time = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleString('hi-IN') : '';
      const img = d.selfie || 'https://via.placeholder.com/100?text=No+Img';
      
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="card-header"><span>${time}</span></div>
        <div class="card-body">
          <img src="${img}" class="user-img" onclick="viewImg('${img}','${d.name}')">
          <div class="info">
            <h3>${d.name}</h3>
            <p>üìû <a href="tel:${d.mobile}" style="color:#555;text-decoration:none;">${d.mobile}</a></p>
            <p>üë®‚Äçüíº ${d.designation}</p>
            <p>üìç ${d.address}</p>
            <div class="tags">
              <span class="tag tag-dist">${d.district}</span>
              <span class="tag tag-mandal">${d.mandal}</span>
              <span class="tag tag-reason">${d.reason}</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn-del" onclick="delEntry('${d.id}')">Delete</button>
        </div>
      `;
      grid.appendChild(div);
    });
    
    if(data.length > 200) {
        grid.innerHTML += `<div style="grid-column:1/-1;text-align:center;padding:10px;color:#777;">...Viewing 200 of ${data.length} records. Use filters to see specific data...</div>`;
    }
  }

  function populateDropdowns() {
    const dists = new Set(); const mandals = new Set(); const reasons = new Set();
    allData.forEach(d => {
      if(d.district) dists.add(d.district);
      if(d.mandal) mandals.add(d.mandal);
      if(d.reason) reasons.add(d.reason);
    });
    fillSelect('filterDist', dists); fillSelect('filterMandal', mandals); fillSelect('filterReason', reasons);
  }

  function fillSelect(id, set) {
    const sel = document.getElementById(id);
    const val = sel.value;
    sel.innerHTML = sel.options[0].outerHTML;
    Array.from(set).sort().forEach(v => {
      const op = document.createElement('option'); op.value=v; op.textContent=v; sel.appendChild(op);
    });
    sel.value = val;
  }

  function updateCharts(data) {
    const distCounts = {}; data.forEach(d => distCounts[d.district] = (distCounts[d.district]||0)+1 );
    const reasonCounts = {}; data.forEach(d => reasonCounts[d.reason] = (reasonCounts[d.reason]||0)+1 );
    renderChart('districtChart', distCounts, 'bar', distChartInst, (i)=>distChartInst=i);
    renderChart('reasonChart', reasonCounts, 'pie', reasonChartInst, (i)=>reasonChartInst=i);
  }

  function renderChart(cId, dObj, type, inst, setInst) {
    if(inst) inst.destroy();
    const ctx = document.getElementById(cId).getContext('2d');
    setInst(new Chart(ctx, {
      type: type,
      data: {
        labels: Object.keys(dObj),
        datasets: [{ data: Object.values(dObj), backgroundColor: ['#ff6a00','#36a2eb','#ffcd56','#4bc0c0','#9966ff','#ff9f40'], borderWidth:1 }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    }));
  }

  async function manageEvent() {
    const snap = await db.collection('events').where('active','==',true).get();
    let currentEvent = ""; if(!snap.empty) currentEvent = snap.docs[0].data().name;
    const { value: eventName } = await Swal.fire({ title: '‡§á‡§µ‡•á‡§Ç‡§ü ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏', input: 'text', inputValue: currentEvent, showCancelButton: true });
    if (eventName !== undefined) {
      const batch = db.batch();
      const old = await db.collection('events').where('active','==',true).get();
      old.forEach(doc => batch.update(doc.ref, { active: false }));
      if(eventName.trim()) {
        const newRef = db.collection('events').doc();
        batch.set(newRef, { name: eventName, active: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        Swal.fire("Saved", `Event: ${eventName}`, "success");
      }
      await batch.commit();
    }
  }

  window.viewImg = (url,t) => Swal.fire({ imageUrl: url, title: t, confirmButtonText:'Close' });
  window.delEntry = async (id) => { if((await Swal.fire({title:'Delete?',icon:'warning',showCancelButton:true})).isConfirmed){ db.collection('visitors').doc(id).delete(); } }
  window.exportData = () => {
    let csv = "Name,Mobile,Designation,Address,District,Mandal,Reason,Time\n";
    allData.forEach(r => {
      const t = r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleString().replace(/,/g,'') : '';
      csv += `${r.name},${r.mobile},${r.designation},${r.address},${r.district},${r.mandal},${r.reason},${t}\n`;
    });
    const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,"+csv); link.download = "data.csv"; document.body.appendChild(link); link.click();
  }
</script>
</body>
</html>
