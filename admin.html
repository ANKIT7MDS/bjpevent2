<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Visitors & Events</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#ff6a00;
      --brand-600:#ff7f26;
      --brand-700:#ff9933;
      --brand-800:#e25800;
      --text:#202124;
      --muted:#6b7280;
      --surface:#ffffff;
      --bg:#fff8f1;
      --line:#f1f5f9;
      --chip:#fff2e6;
    }
    *{box-sizing:border-box}
    body{font-family:'Noto Sans Devanagari',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);margin:0;color:var(--text)}
    .wrap{max-width:1280px;margin:24px auto;background:var(--surface);padding:18px 18px 28px;border-radius:16px;box-shadow:0 8px 24px rgba(255,106,0,.12)}
    .brandbar{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .branddot{height:14px;width:14px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px #ffe5d1}
    h1{margin:0 0 4px;font-weight:800}
    .subtitle{color:var(--muted);font-size:14px;margin-bottom:12px}
    .filters{display:grid;grid-template-columns:repeat(7,minmax(140px,1fr));gap:10px}
    .filters .cell{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:#555}
    input,select,button{padding:10px;border:1px solid var(--line);border-radius:10px;font-size:14px;background:#fff}
    button.btn{background:var(--brand);color:#fff;border:none;cursor:pointer;transition:.15s;box-shadow:0 4px 10px rgba(255,106,0,.18)}
    button.btn:hover{background:var(--brand-800)}
    button.btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    button.btn.danger{background:#dc2626}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px dashed var(--brand-700);background:var(--chip);border-radius:999px;cursor:pointer;font-size:12px}
    .chip.active{background:var(--brand);color:#fff;border-style:solid}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left;font-size:14px}
    th{background:#fff6ee;position:sticky;top:0;z-index:1}
    .foot{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:14px 0}
    .empty{padding:16px;color:#777}
    img.preview{height:44px;width:44px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid #eee}
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px}
    .card{border:1px solid #ffe1c4;border-radius:14px;padding:12px;background:#fffefb}
    .card h3{margin:0 0 8px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .notice{background:#fff1e6;border:1px solid #ffd2ad;padding:10px;border-radius:10px;color:#7a3e00}
    .table-wrap{border:1px solid #eee;border-radius:12px;overflow:auto;margin-top:12px;max-height:60vh;background:#fff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#fff;border:1px solid var(--brand);color:var(--brand)}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase (Compat for simplicity here) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="brandbar"><div class="branddot"></div><h1>एडमिन पैनल</h1></div>
    <div class="subtitle">पुराने रिकॉर्ड लोड, कार्यक्रम-वाइज फ़िल्टर, कार्यालय/इवेंट अलग व्यू, थम्बनेल, माह/दिन के अनुसार काउंट, और ऑरेंज–व्हाइट थीम।</div>

    <div class="chips" style="margin-bottom:8px">
      <div class="chip active" data-type="">सभी विज़िटर</div>
      <div class="chip" data-type="office">भाजपा कार्यालय (डेली)</div>
      <div class="chip" data-type="event">इवेंट विज़िटर</div>
    </div>

    <div class="filters" style="margin-bottom:12px">
      <div class="cell"><label>From</label><input type="date" id="fromDate"></div>
      <div class="cell"><label>To</label><input type="date" id="toDate"></div>
      <div class="cell"><label>आने का कारण</label>
        <select id="reasonSelect"><option value="">— सभी —</option></select>
      </div>
      <div class="cell"><label>Mandal</label><select id="mandalSelect"><option value="">— सभी —</option></select></div>
      <div class="cell"><label>इवेंट</label><select id="eventSelect"><option value="">— सभी —</option></select></div>
      <div class="cell"><label>फ़्रीक्वेंसी</label>
        <select id="freqSelect">
          <option value="">— सभी —</option>
          <option value="more">अधिक बार (≥3)</option>
          <option value="less">कम बार (≤1)</option>
        </select>
      </div>
      <div class="cell"><label>खोजें</label><input id="searchInput" placeholder="नाम/मोबाइल/पता"></div>
    </div>
    <div class="toolbar">
      <button id="clearBtn" class="btn ghost">♻️ Clear Filters</button>
      <span id="activeTypeBadge" class="badge">व्यू: सभी</span>
    </div>

    <div class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="eventNameInput" placeholder="नया इवेंट नाम" style="min-width:260px">
          <button id="addEventBtn" class="btn">इवेंट जोड़ें</button>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <label>Active:</label>
          <select id="eventActiveSelect" style="min-width:240px"></select>
          <button id="setActiveBtn" class="btn">Active करें</button>
          <button id="endEventBtn" class="btn danger">इवेंट Deactivate</button>
        </div>
      </div>
      <div class="notice">वर्तमान Active: <b id="activeEventLabel">—</b>. इवेंट Deactivate होने पर केवल कार्यालय कारण दिखेंगे और डिफ़ॉल्ट फॉर्म लागू होगा।</div>
    </div>

    <div class="table-wrap">
      <table id="dataTable">
        <thead>
          <tr>
            <th>समय</th><th>नाम</th><th>मोबाइल</th><th>पद</th><th>मंडल</th><th>आने का कारण</th><th>पता</th><th>फोटो</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="emptyState" class="empty" style="display:none">कोई डेटा नहीं मिला…</div>
    </div>

    <div class="foot">
      <div style="display:flex; gap:8px; align-items:center;flex-wrap:wrap">
        <button id="firstPage" class="btn">⏮</button>
        <button id="prevPage" class="btn">◀</button>
        <span id="pageInfo">Page 1 / 1</span>
        <button id="nextPage" class="btn">▶</button>
        <button id="lastPage" class="btn">⏭</button>
        <span id="rowInfo" style="color:#666">(0–0 of 0)</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;flex-wrap:wrap">
        <button id="loadOlderBtn" class="btn ghost">⬇️ पुराने रिकॉर्ड (1000)</button>
        <button id="loadAllBtn" class="btn ghost">⚡ सभी पुराने रिकॉर्ड</button>
        <button id="exportBtn" class="btn">Export CSV</button>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <h3>टॉप 10 विज़िटर</h3>
        <div id="top10Table"></div>
      </div>
      <div class="card">
        <h3>माह-वाइज / डेट-वाइज</h3>
        <div class="grid2">
          <div>
            <label>माह चुनें</label>
            <input type="month" id="monthPicker">
            <div id="monthWiseTable" style="margin-top:8px"></div>
          </div>
          <div>
            <div id="dateWiseTable"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
    authDomain: "bjplivefirebase.firebaseapp.com",
    projectId: "bjplivefirebase"
  };
  if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const $ = (id)=>document.getElementById(id);

  // 5 निश्चित कार्यालय के कारण (dropdown)
  const OFFICE_REASONS = [
    "कार्यालय पर बैठक",
    "जिला अध्यक्ष से भेंट",
    "ट्रांसफर / शासकीय कार्य / शिकायत",
    "कार्यालय पर सामान्य उपस्थिति",
    "अन्य कोई कार्य"
  ];
  const MANDALS = [
    "भेंसोदा","भानपुरा","गरोठ","मेलखेडा","खड़ावदा","शामगढ़","सुवासरा","बसाई",
    "सीतामऊ","क्यामपुर","सीतामऊ ग्रामीण","गुर्जर बरडिया","धुंदधड़का","बुढा",
    "पिपलिया मंडी","मल्हारगढ़","दलोदा","मगरामाता जी","मंदसौर ग्रामीण",
    "मंदसौर उत्तर","मंदसौर दक्षिण","अन्य जिले से आये"
  ];

  const state = {
    all: [],
    lastDoc: null,
    page: 1,
    pageSize: 25,
    filtered: [],
    events: [],
    activeEvent: null,
    viewType: "",
  };

  function tsToLocal(ts){
    try{ const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
      return d ? d.toLocaleString('en-IN',{hour12:false}) : ''; }catch(_){ return ''; }
  }

  function fillSelect(sel, items, placeholder){
    sel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = placeholder || '— चुनें —';
    sel.appendChild(opt0);
    items.forEach(v=>{
      const op = document.createElement('option'); op.value = v; op.textContent = v;
      sel.appendChild(op);
    });
  }

  function computeDisplayReason(row){
    const active = state.events.find(e=>e.active);
    const isOfficeReason = OFFICE_REASONS.includes(row.reason||"");
    const rowHasEvent = !!(row.eventId || row.eventName || (!isOfficeReason && (row.reason||"").length>0));

    // नियम:
    // - Admin टेबल में "इवेंट" नाम का अलग कॉलम नहीं है
    // - अगर Active Event है और पंक्ति इवेंट से संबंधित है, तो "आने का कारण" में सिर्फ Active Event का नाम दिखाएँ
    // - अन्यथा, केवल 5 कार्यालय कारणों में से जो भी हो वही दिखाएँ, नहीं तो "—"
    if (active && rowHasEvent){
      return active.name || "इवेंट";
    }
    return isOfficeReason ? (row.reason||"") : "—";
  }

  function applyFilter(){
    const q = ($('searchInput').value || '').toLowerCase().trim();
    const fr = $('fromDate').value; const to = $('toDate').value;
    const rs = $('reasonSelect').value; const md = $('mandalSelect').value;
    const ev = $('eventSelect').value;
    const fq = $('freqSelect').value;
    const type = state.viewType;

    let rows = [...state.all];

    if (type === 'office'){
      rows = rows.filter(r => (r.type || r.category || 'office') === 'office' || (r.reason||'').includes('कार्यालय'));
    } else if (type === 'event'){
      rows = rows.filter(r => (r.type || r.category) === 'event' || r.eventId || r.eventName || (!OFFICE_REASONS.includes(r.reason||"")));
    }

    if (fr) { const s = new Date(fr + 'T00:00:00'); rows = rows.filter(r => r.timestamp?.toDate ? r.timestamp.toDate() >= s : true); }
    if (to) { const e = new Date(to + 'T23:59:59'); rows = rows.filter(r => r.timestamp?.toDate ? r.timestamp.toDate() <= e : true); }
    if (rs) rows = rows.filter(r => (r.reason || '') === rs);
    if (md) rows = rows.filter(r => (r.mandal || '') === md);
    if (ev) rows = rows.filter(r => (r.eventId || r.eventName || '') === ev);

    if (q) {
      rows = rows.filter(r => {
        const blob = `${r.name||''} ${r.mobile||''} ${r.address||''} ${r.designation||''}`.toLowerCase();
        return blob.includes(q);
      });
    }

    if (fq){
      const countByKey = new Map();
      rows.forEach(r => {
        const k = `${r.mobile||''}|${r.name||''}`;
        countByKey.set(k, (countByKey.get(k)||0)+1);
      });
      rows = rows.filter(r => {
        const k = `${r.mobile||''}|${r.name||''}`;
        const c = countByKey.get(k)||0;
        if (fq==='more') return c >= 3;
        if (fq==='less') return c <= 1;
        return true;
      });
    }

    state.filtered = rows.sort((a,b)=> (b.timestamp?.toMillis?.()||0) - (a.timestamp?.toMillis?.()||0));
    state.page = 1;
    renderTable();
    renderTop10();
    renderMonthAndDateTables();
  }

  function renderTable(){
    const tbody = $('dataTable').querySelector('tbody');
    tbody.innerHTML = '';
    const total = state.filtered.length;
    const pages = Math.max(1, Math.ceil(total / state.pageSize));
    state.page = Math.min(state.page, pages);

    const start = (state.page - 1) * state.pageSize;
    const slice = state.filtered.slice(start, start + state.pageSize);

    if (!slice.length){
      $('emptyState').style.display = 'block';
    } else {
      $('emptyState').style.display = 'none';
      slice.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${tsToLocal(row.timestamp)}</td>
          <td>${row.name||''}</td>
          <td>${row.mobile||''}</td>
          <td>${row.designation||''}</td>
          <td>${row.mandal||''}</td>
          <td>${computeDisplayReason(row)}</td>
          <td>${row.address||''}</td>
          <td>${row.selfie ? `<a href="${row.selfie}" target="_blank"><img class="preview" src="${row.selfie}" alt="फोटो"></a>` : ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    $('pageInfo').textContent = `Page ${state.page} / ${pages}`;
    const from = total ? start + 1 : 0;
    const to = start + slice.length;
    $('rowInfo').textContent = `(${from}–${to} of ${total})`;
  }

  function renderTop10(){
    const map = new Map();
    state.filtered.forEach(r=>{
      const key = `${r.name||''}|${r.mobile||''}`;
      map.set(key, (map.get(key)||0)+1);
    });
    const arr = [...map.entries()].map(([k,c])=>{
      const [n,m] = k.split('|'); return { name:n||'(अनाम)', mobile:m||'', count:c };
    }).sort((a,b)=>b.count-a.count).slice(0,10);

    const html = arr.length
      ? `<table style="width:100%;border-collapse:collapse">
           <thead><tr>
             <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">नाम</th>
             <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">मोबाइल</th>
             <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">कुल विज़िट</th>
           </tr></thead>
           <tbody>${arr.map(x=>`<tr>
             <td style="padding:6px;border-bottom:1px solid #f5f5f5">${x.name}</td>
             <td style="padding:6px;border-bottom:1px solid #f5f5f5">${x.mobile}</td>
             <td style="padding:6px;border-bottom:1px solid #f5f5f5"><b>${x.count}</b></td>
           </tr>`).join('')}</tbody>
         </table>`
      : '—';
    $('top10Table').innerHTML = html;
  }

  function renderMonthAndDateTables(){
    // Month-wise table over all filtered rows
    const byMonth = new Map();
    state.filtered.forEach(r=>{
      const d = r.timestamp?.toDate ? r.timestamp.toDate() : null;
      if (!d) return;
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      byMonth.set(key, (byMonth.get(key)||0)+1);
    });
    const monthRows = [...byMonth.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    $('monthWiseTable').innerHTML = monthRows.length
      ? `<table style="width:100%;border-collapse:collapse">
           <thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">माह</th><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">कुल</th></tr></thead>
           <tbody>${monthRows.map(([m,c])=>`<tr><td style="padding:6px;border-bottom:1px solid #f5f5f5">${m}</td><td style="padding:6px;border-bottom:1px solid #f5f5f5">${c}</td></tr>`).join('')}</tbody>
         </table>`
      : '—';

    // Date-wise table for selected month
    const mp = $('monthPicker').value;
    const byDate = new Map();
    state.filtered.forEach(r=>{
      const d = r.timestamp?.toDate ? r.timestamp.toDate() : null;
      if (!d) return;
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      if (mp && ym !== mp) return;
      const key = d.toISOString().slice(0,10);
      byDate.set(key, (byDate.get(key)||0)+1);
    });
    const dateRows = [...byDate.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    $('dateWiseTable').innerHTML = dateRows.length
      ? `<table style="width:100%;border-collapse:collapse">
           <thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">तारीख</th><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">कुल</th></tr></thead>
           <tbody>${dateRows.map(([d,c])=>`<tr><td style="padding:6px;border-bottom:1px solid #f5f5f5">${d}</td><td style="padding:6px;border-bottom:1px solid #f5f5f5">${c}</td></tr>`).join('')}</tbody>
         </table>`
      : '—';
  }

  function loadStaticFilters(){
    fillSelect($('reasonSelect'), OFFICE_REASONS, '— सभी —'); // केवल 5 कार्यालय कारण
    fillSelect($('mandalSelect'), MANDALS, '— सभी —');
  }

  function renderEventsDropDowns(){
    const sel = $('eventSelect');
    sel.innerHTML = '<option value="">— सभी —</option>';
    state.events.forEach(ev => {
      const op = document.createElement('option');
      op.value = ev.id || ev.name;
      op.textContent = ev.name + (ev.active ? ' (Active)' : '');
      sel.appendChild(op);
    });
    const select = $('eventActiveSelect');
    select.innerHTML = '<option value="">— इवेंट चुनें —</option>';
    state.events.forEach(ev=>{
      const op = document.createElement('option');
      op.value = ev.id; op.textContent = ev.name + (ev.active ? ' (Active)' : '');
      select.appendChild(op);
    });
    const active = state.events.find(e => e.active);
    $('activeEventLabel').textContent = active ? active.name : '—';
  }

  // Batch helpers for event active toggle
  async function setOnlyThisActive(docId){
    const batch = db.batch();
    const all = await db.collection('events').get();
    all.forEach(d => batch.update(d.ref, { active: d.id === docId }));
    await batch.commit();
  }
  async function clearActive(){
    const all = await db.collection('events').where('active','==',true).get();
    const batch = db.batch();
    all.forEach(d => batch.update(d.ref, { active:false }));
    await batch.commit();
  }

  // Live latest
  db.collection("visitors").orderBy("timestamp","desc").limit(1000)
    .onSnapshot((snap) => {
      const latest = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      const map = new Map(state.all.map(r=>[r.id,r]));
      latest.forEach(r=>map.set(r.id,r));
      state.all = [...map.values()].sort((a,b)=> (b.timestamp?.toMillis?.()||0) - (a.timestamp?.toMillis?.()||0));
      if (latest.length) state.lastDoc = snap.docs[snap.docs.length-1];
      applyFilter();
    });

  // Load older single-page (1000)
  $('loadOlderBtn').addEventListener('click', async ()=>{
    await loadOlderOnce();
  });

  async function loadOlderOnce(){
    try{
      if (!state.lastDoc){
        Swal.fire('ध्यान दें', 'और पुराने रिकॉर्ड लोड करने के लिए पहले कुछ डेटा दिखना चाहिए।', 'info');
        return;
      }
      const q = db.collection("visitors").orderBy("timestamp","desc").startAfter(state.lastDoc).limit(1000);
      const snap = await q.get();
      const older = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      state.lastDoc = snap.docs[snap.docs.length-1] || state.lastDoc;
      const map = new Map(state.all.map(r=>[r.id,r]));
      older.forEach(r=>map.set(r.id,r));
      state.all = [...map.values()].sort((a,b)=> (b.timestamp?.toMillis?.()||0) - (a.timestamp?.toMillis?.()||0));
      applyFilter();
      if (!older.length){
        Swal.fire('रिकॉर्ड पूर्ण', 'और पुराने रिकॉर्ड उपलब्ध नहीं हैं।', 'info');
      }
    }catch(err){
      console.error(err);
      Swal.fire('Error', 'पुराने रिकॉर्ड लाने में समस्या आई।', 'error');
    }
  }

  // Load ALL older (loop until empty) — ताकि 1200-1500 जैसी पूरी हिस्ट्री आ जाए
  $('loadAllBtn').addEventListener('click', async ()=>{
    let added = 0;
    try{
      if (!state.lastDoc){
        Swal.fire('ध्यान दें', 'सभी पुराने रिकॉर्ड लोड करने के लिए पहले वर्तमान डेटा चाहिए।', 'info');
        return;
      }
      while(true){
        const q = db.collection("visitors").orderBy("timestamp","desc").startAfter(state.lastDoc).limit(1000);
        const snap = await q.get();
        if (snap.empty) break;
        const older = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        state.lastDoc = snap.docs[snap.docs.length-1] || state.lastDoc;
        const map = new Map(state.all.map(r=>[r.id,r]));
        older.forEach(r=>map.set(r.id,r));
        const before = state.all.length;
        state.all = [...map.values()].sort((a,b)=> (b.timestamp?.toMillis?.()||0) - (a.timestamp?.toMillis?.()||0));
        added += (state.all.length - before);
        applyFilter();
        if (older.length < 1000) break; // last page
      }
      Swal.fire('पूर्ण', `लोड हो गया। जोड़े गए रिकॉर्ड: ${added}`, 'success');
    }catch(err){
      console.error(err);
      Swal.fire('Error', 'सभी पुराने रिकॉर्ड लोड करने में समस्या।', 'error');
    }
  });

  // live events
  db.collection('events').orderBy('createdAt','desc').onSnapshot(s=>{
    state.events = s.docs.map(d=>({ id: d.id, ...d.data() }));
    renderEventsDropDowns();
    applyFilter(); // reason-render depends on active event
  });

  // UI actions
  document.querySelectorAll('.chip').forEach(el=>el.addEventListener('click',()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    el.classList.add('active');
    state.viewType = el.dataset.type || '';
    $('activeTypeBadge').textContent = 'व्यू: ' + (state.viewType===''?'सभी':(state.viewType==='office'?'भाजपा कार्यालय':'इवेंट'));
    applyFilter();
  }));

  $('fromDate').addEventListener('change', applyFilter);
  $('toDate').addEventListener('change', applyFilter);
  $('reasonSelect').addEventListener('change', applyFilter);
  $('mandalSelect').addEventListener('change', applyFilter);
  $('eventSelect').addEventListener('change', applyFilter);
  $('freqSelect').addEventListener('change', applyFilter);
  $('searchInput').addEventListener('input', applyFilter);

  $('clearBtn').addEventListener('click', ()=>{
    $('fromDate').value=''; $('toDate').value=''; $('reasonSelect').value='';
    $('mandalSelect').value=''; $('eventSelect').value=''; $('freqSelect').value='';
    $('searchInput').value=''; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    document.querySelector('[data-type=""]').classList.add('active'); state.viewType=''; $('activeTypeBadge').textContent='व्यू: सभी'; applyFilter();
  });

  $('addEventBtn').addEventListener('click', async ()=>{
    const name = ($('eventNameInput').value || '').trim();
    if (!name) return Swal.fire('नाम चाहिए', 'इवेंट का नाम दर्ज करें', 'warning');
    await db.collection('events').add({ name, active:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    $('eventNameInput').value='';
  });
  $('setActiveBtn').addEventListener('click', async ()=>{
    const id = $('eventActiveSelect').value;
    if (!id) return;
    await setOnlyThisActive(id);
    Swal.fire('Done', 'यह इवेंट अब Active है', 'success');
  });
  $('endEventBtn').addEventListener('click', async ()=>{
    await clearActive();
    Swal.fire('Done', 'Active इवेंट हटाया गया — डिफ़ॉल्ट फॉर्म सक्रिय।', 'success');
  });

  // export
  $('exportBtn').addEventListener('click', ()=>{
    const rows = state.filtered.map(r=>({
      timestamp: tsToLocal(r.timestamp), name: r.name||'', mobile: r.mobile||'',
      designation: r.designation||'', mandal: r.mandal||'',
      reason: computeDisplayReason(r),
      address: r.address||'', selfie: r.selfie||''
    }));
    const headers = Object.keys(rows[0] || {timestamp:'',name:'',mobile:'',designation:'',mandal:'',reason:'',address:'',selfie:''});
    const csv = [headers.join(',')].concat(
      rows.map(r=>headers.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))
    ).join('\\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'visitors_export.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  // init
  fillSelect($('reasonSelect'), OFFICE_REASONS, '— सभी —');
  fillSelect($('mandalSelect'), MANDALS, '— सभी —');
  (function initMonth(){ const d=new Date(); $('monthPicker').value = d.toISOString().slice(0,7); })();
  $('monthPicker').addEventListener('change', renderMonthAndDateTables);
</script>
</body>
</html>
